#!/usr/bin/env bash

# This script sets the Kubernetes context after a Boundary session is created.
# Before you run this script:
# 1. Establish session thru Boundary desktop.
# 2. Copy Boundary proxy port value as PORT environment variable.
# 3. Copy service_account_token value as REMOTE_USER_TOKEN environment variable.
# 4. Copy ca_crt value as CA_RAW variable.

export CLUSTER_NAME=my-aks-cluster
export PORT=63666
export REMOTE_USER_TOKEN=eyJhbGciOiJSUzI1NiIsImtpZCI6IlBRVTgyVzlKV1JXdkJLYTFmYWxtRW9hbWR3bF9RRUxvSXZHeG44YktwLXMifQ.eyJhdWQiOlsiaHR0cHM6Ly9ib3VuZGFyeS1kZW1vLWg5eWtjd3hyLmhjcC5lYXN0dXMyLmF6bWs4cy5pbyIsIlwiYm91bmRhcnktZGVtby1oOXlrY3d4ci5oY3AuZWFzdHVzMi5hem1rOHMuaW9cIiJdLCJleHAiOjE3MTA4NzY3NjMsImlhdCI6MTcxMDg1NTE2MywiaXNzIjoiaHR0cHM6Ly9ib3VuZGFyeS1kZW1vLWg5eWtjd3hyLmhjcC5lYXN0dXMyLmF6bWs4cy5pbyIsImt1YmVybmV0ZXMuaW8iOnsibmFtZXNwYWNlIjoiZGVmYXVsdCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJ2LXRva2VuLXRvLWF1dG8tbWFuLTE3MTA4NTUxNjMtdmNhbzdxbXcwNW12Zml5emlubXZveG41IiwidWlkIjoiY2JkNGI4NmQtNTJiZC00YjE1LTliYTAtNzY4MzFhYzMyZGIzIn19LCJuYmYiOjE3MTA4NTUxNjMsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnYtdG9rZW4tdG8tYXV0by1tYW4tMTcxMDg1NTE2My12Y2FvN3FtdzA1bXZmaXl6aW5tdm94bjUifQ.aLCknH-0zUYJ6qPTzc5WxAkEiJjpmGy8fGa1vPp0Y52mOmNUDQXypV4iG2ldXEvAHbHXE8th-_MzGYZLbGeTq7l38MXaF_zQl7V5yD2ZGanz1QCUdTSSfznyG1rTE8yKxSLpgqPhm5VRjFeKkvIBLoe4U7gK_ibqrYOy0RyHcu9aH8YxQF-ruk_ipxBVEUDzVq14dzT1j6sCRPvePfq-ZiXahOFb5qoabPYrBbrtzcfEa3pHvs7fHAeu9aCOh5GqKkJLz9_d0nvsuUKXQhWmuAUykkfnC8Y_K5xR-Kvllv_ELIpsYRGXe1ENg98_zu4zEK6vMS8Q9hZLiwDTWfIidQSlJDA7j_i8T0n2tplQTouE8cpnf_Nn1XMI2SjpOMfG9oo4bd6E-vR1yEfRvnJ9vSadyxOlHDQ--7WQpcNHqps98E_IceLBJBti1E5TvNA_S7ESPKcWs1QFdApbMDONqxM0iIQrq3Sg2BrOPpxwgLwUNb_5XXRAI37AueHaiexXPOcaCuZjGSizL6tYNt-XBmN8d9B5anWgLNp2S3DFwRs-4Bwl-jPqz0CHJqKlDwou1SMFs1j3ZI7ejto3BPqQfCsqBkLJMirC7eIRYjcggjNvhwMF9r4eIhXZLJk3m1bPJSth3UZ5mfTorkUKGpJb8T9uhfdGsNLVSRa4nekov00
CA_RAW="-----BEGIN CERTIFICATE-----\nMIIE6DCCAtCgAwIBAgIQSAz8jSvEw1ihecfQ/uC+mjANBgkqhkiG9w0BAQsFADAN\nMQswCQYDVQQDEwJjYTAgFw0yNDAzMTgyMzMzMjBaGA8yMDU0MDMxODIzNDMyMFow\nDTELMAkGA1UEAxMCY2EwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQDR\nZ6hkdeTecBQffBt4MB+2B11pxyh9pD048/ki/PlqjC1auoyzGsBFoaDokkVbIlQ3\nZtkHRbTB2UpVPyEN38vX+CY0FQmg40R14khHCHvhOaScO9gtflmGitZunGFZeG9G\nyipTJWsJ9vqEQYK5KWZh5EL4AuOIGuQqa4zWIRheoahTPSYrqYMW53Q0FLpj8ndQ\nkbsbRQbXKglDnr9AqMP+gTa7ewp3EVjbY7UWoY7RB2L5CnmtesOHDbxqRBCh64Sd\nOQXIJstVfpEl+ZHDoQ2+eMajzJZ17cS2DEljcRBXzrDlGNhZ3DdDZH5pMsCvv45w\n8CEdCD51J7rUGna7j3N6adNZnCSF0ywLodGjy7RBaETMEDVYYqAWg+KaITHXEKo4\nBr1VsXTWG1sxp2MGGMdOz+B9qemx6KXntrZZVo2HsIWW4JIkOfnM9wseWo9Zrpp1\nYBMOLY8VhqpxJyKmXpou+HPUH/QVcbN/QDRiX7BrO24sgkoYGJYrDxDdipDKlQ9y\nJEa4HzvT6vjlsMxZ3s0txdBaiaU6Bx9qGy/KYmYwNC11DKbRzYuXX8/CUJCOEY4j\nFiQEykwfD7gang710gaH3AJM21jeo65cKXwCP7h/t5gxLmNqp2RACCYHsbV70/8B\nguaYIRfaExA+JppTE/9kI7xfMkrrZMYlHCM6B//DzwIDAQABo0IwQDAOBgNVHQ8B\nAf8EBAMCAqQwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUKj5bQm9XjJbLMpYx\nRlpozi+AIoIwDQYJKoZIhvcNAQELBQADggIBAHotRvxthzIQ5qP4UK6xKfjDuEGN\nDZ//9dRE1mLpDln78vKYQ56hjIP9zjlzHSY+G0/gJO4qHNIIAh0NVqW9+dmpenLB\nSjAP19PRbZSexY2DSIVgSH6Ied4+ixFvefL+TQ0HawIjRk3O/82r52wEsri+dbVc\ncew4YRS6pdItFWCs3+nRvRbW92V/VSV86vlo9dzbyYkx9gsIFlRmIdUXq0N5C+GL\nI17EWz/RRUbnhMhXmSI7o5ZAJNZq9GQ4Wwf8njmTqhdEghYZh6z0rPDXaVCL4TGF\n55hBmxyfeDMtKCn1Fg0VpMJ4RM7A1qkBJHOKcsEerBEzNVDU6yyjakpWQh/pmRv6\nwAChJXA2oz6bh1J4PkyJglbej/zG56A334hbQk+H6ugll32T5XhRRjCOxzeft/Ds\nSPfCJV67S4JKAoYUPUlmGEb8V6hsWrQrpdIiJAg/LfhSFgh3zHEbKb4JIdHydJAx\nXmIgBNnhsU4e5qewpFq6aiR9RfDum0TTf/7BwhHyy2C5UjwYbYQ5OU4bmwNOpfLy\n86CAgBQQq2bj0b9WROh14TsE5B+mpzwgMuak3Hk6iMAPpucbw4iGS60+38CeDygm\n2k7m5+cCW92AcYUSglsUWf6Bg7l2UMxrwS79miakRKHaNxalNl12LEtYEYNqprnd\ne8f6Nl6bQDn1H1a8\n-----END CERTIFICATE-----\n"

tput setaf 12 && echo "### Setting Kubernetes context ###" && tput sgr0

echo "--> Cluster name is: ${CLUSTER_NAME}"
echo "--> Port number is: ${PORT}"
echo "Configuring Kubernetes contexts..."

echo $CA_RAW | sed 's/\\n/\n/g' | sed 's/"//' > ./scripts/ca.crt

kubectl config set-cluster $CLUSTER_NAME --server=https://127.0.0.1:$PORT --tls-server-name kubernetes --certificate-authority=./scripts/ca.crt

kubectl config set-context $CLUSTER_NAME --cluster=$CLUSTER_NAME
kubectl config set-credentials boundary-user --token=$REMOTE_USER_TOKEN
kubectl config set-context $CLUSTER_NAME --user=boundary-user
kubectl config use-context $CLUSTER_NAME