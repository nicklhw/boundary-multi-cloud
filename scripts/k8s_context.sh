#!/usr/bin/env bash

# This script sets the Kubernetes context after a Boundary session is created.
# Before you run this script:
# 1. Establish session thru Boundary desktop.
# 2. Copy Boundary proxy port value as PORT environment variable.
# 3. Copy service_account_token value as REMOTE_USER_TOKEN environment variable.
# 4. Copy ca_crt value as CA_RAW variable.

export CLUSTER_NAME=my-aks-cluster
export PORT=58494
export REMOTE_USER_TOKEN=eyJhbGciOiJSUzI1NiIsImtpZCI6IkU2Y3J1X3B2aWhQOUU5c2FPdmVWZjhOc1d2cW1INVIzcHdDYUllaDZ5M2MifQ.eyJhdWQiOlsiaHR0cHM6Ly9ib3VuZGFyeS1kZW1vLXI1aTRjZHphLmhjcC5lYXN0dXMyLmF6bWs4cy5pbyIsIlwiYm91bmRhcnktZGVtby1yNWk0Y2R6YS5oY3AuZWFzdHVzMi5hem1rOHMuaW9cIiJdLCJleHAiOjE3MDc0MjY2OTEsImlhdCI6MTcwNzQwNTA5MSwiaXNzIjoiaHR0cHM6Ly9ib3VuZGFyeS1kZW1vLXI1aTRjZHphLmhjcC5lYXN0dXMyLmF6bWs4cy5pbyIsImt1YmVybmV0ZXMuaW8iOnsibmFtZXNwYWNlIjoiZGVmYXVsdCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJ2LXRva2VuLXRvLWF1dG8tbWFuLTE3MDc0MDUwOTAtdHpzdWgxZXFrcXJkd3RkZHRseXgxc2I0IiwidWlkIjoiODU3M2M5ZTktNjQ5Yi00MjY2LWE1N2YtMzFlNmI0YWEzYzRhIn19LCJuYmYiOjE3MDc0MDUwOTEsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnYtdG9rZW4tdG8tYXV0by1tYW4tMTcwNzQwNTA5MC10enN1aDFlcWtxcmR3dGRkdGx5eDFzYjQifQ.SzjJBpOMkGpff17sZFI9BHWaza5pzb9ixghHG0AnKItVuxeuywbELuh7rmaa5iLjWCA0Q2hCS3CxJ4IgAoyM9f2-NscN0dlvqItSpQpVrSybUQ4hP8epdsfAS43lt74ZSOnzyIQ1OgTS30krQigPne5YTzJSDrFmVkT-BrzSeX82K-T0TphMPLqrc-Wa7MrBIoCmq8Y1QZITEi4xBu5ihcktonAFXqi1oL6PNXRp7DP9rL8nIO-tQ7TArxQrkmZufPJYCU1I6P-UXFgdYtYRNB2bg8Nwpqv1bTeZqGuEgIwCvg8qSLUkMoO7OZA0cfMjgUukR1Koa5CYvv5E8TjvAn7JamZoGcjHYxkbY7PclIcqPL8Hf2fucrYafeJsKqEElLto7kkt6H142upR_7_xWhZhLogR94nZpDflo52-ZYwShLIhqzoSV18T-Dey30SrXJOWlnnacIjw9XrBcujQYKIJK2j9icvhF3WTp3Uq3h0sYCvqPLAsw_AxK75naVaqKKUlu2EGyTgOxQKiVyIAAIkVBSLULACccA6HF67fbkxhGfv3JaJV3LrDc7So36M1MIkJEPJyC0bb0q3bukEtVl6b3f8D-X1pKMcN31ZTI04QnL4aODq3ROxJgJbl7aF6WPN3A4psbkZOrclpYm5WkYTz_dZyxfNN_4vKl97acIw
CA_RAW="-----BEGIN CERTIFICATE-----\nMIIE6TCCAtGgAwIBAgIRAOMjwkACJasTIPaAkQePu0owDQYJKoZIhvcNAQELBQAw\nDTELMAkGA1UEAxMCY2EwIBcNMjQwMjA2MjAyNjQ5WhgPMjA1NDAyMDYyMDM2NDla\nMA0xCzAJBgNVBAMTAmNhMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA\nq9uiXkANIi4JXx9/JL21pCuxpuGQswhg100HrOcDsmbJxaVHzvaKD1pneXqSrg8J\n/oFQ4Ne4X3+D2ItJuG5otltzM3zB3QdZcUFZL1UdAGbXL7wtFKa91LEo102xotCw\nM/wY5MDuQD7yK9hCJmqFo4Mv8xbErK41lCffiLPOdNww3NO0awaKjwZkO+VBhTpL\nLKPYgXsu8523dvmg3DJ0l2OpdsjYSoxE0NldR9i30WVM25RUM9qywk0k+iiKACnf\niZQH/ttxziLo6SZtThmO0G2EUGGgmOX33coc4AwuKmkd3UHnL4CFv0Z5+Vtjh5u4\nu3Wtr9y6VCf6OrdLV9GVaaEmEjODs4jKkE8AvPSO7h17F0sZNGYMiTSQnlyUuomm\nd5zj4HTzYAKJqGSxcqA848cRC1jnCgkgGmnBnNlgptjrfsu8UENNevmd3dA6yvrn\nhth6GKMZWHBe7U1i+6yJjgkBTm7Bzl5g6sr1n78+nHv6fY/gyuEJpROs114Z7ngN\njEaKeOwm6TC5OqEPxFDRTDMeRkkx5J2N4X9Fk+W647bcywZBmLClGqZpVnaLdK+t\n2lGZnv/pnbXHQi5PLDvR5PJVayV6qUTd1TsBuAbvoKP3ax3N1pDXKgATL331bqtx\nfUjWcaDO1jtkhf2NagxGUJniIU/xr+7vBYmKdRzMRuECAwEAAaNCMEAwDgYDVR0P\nAQH/BAQDAgKkMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFKM+5CSQO8dAzuqq\n/WjPWjaA2NA8MA0GCSqGSIb3DQEBCwUAA4ICAQAh9B8IUePaVvaaYs+za6kC9Hyv\n+GcZ4uxa/j+R5EqR6JSPayFceSLXjArGvnTlLbgL0/QAsHlcve9I2RtbJuuHsPUo\ncQW9WTdblYu9blJSfuvOQ4dKbbwYM7kKLgiXocE6orYKCtxgOGm5fKHcmZRMU9/R\nmkzDu/kpvSTENp1vTTPA6AM1Z2mJ9VwQsdQO1VH3DaPh9fXbaQfgqj2YkfVxiUwv\nj5LO8STkjKCtRlr7pDTZ4ispST7+n6i4bvtYt2BCrm6wno4/9/s5Q1pnKLwyO/Op\nn1dwbeAtAi4cHGwJNgZWALtiD6MQTw8bg1lL9ipmpMVdDieZMqTHMHpHwynK+FMW\nEm71AB7FpnoRrXryiKm9MM4X7kmR8JRXlir6+iuhnHPlf93xDNlZcUtzA9vCfCX4\n6gQja3rIqQPcEHDr2wQmvRTnVQ3ffdWjZbaatdquYfvDNFsbrZimKPGs1P99yNzU\nGOtn5plpwMzHd0xQzYShHu8tlmBUlRtYXv0Xd9RejjOQvZ0bwiIB/GIBcRIdoiQD\naFhvKaIP7vxa+7bQQ3fRhpErLZYjtlsM6lWQBaLOea59ZiYuzSWIpCB/QvchMyR1\n3Rc6vV8xP9BUNMpknxfFTFGUztJ6hyZMIIIA8DWzSmj8oqwj/rCRHHOOlpMxTy4V\nj9bD0GDVn+qbedVenA==\n-----END CERTIFICATE-----\n"

tput setaf 12 && echo "### Setting Kubernetes context ###" && tput sgr0

echo "--> Cluster name is: ${CLUSTER_NAME}"
echo "--> Port number is: ${PORT}"
echo "Configuring Kubernetes contexts..."

echo $CA_RAW | sed 's/\\n/\n/g' | sed 's/"//' > ./scripts/ca.crt

kubectl config set-cluster $CLUSTER_NAME --server=https://127.0.0.1:$PORT --tls-server-name kubernetes --certificate-authority=./scripts/ca.crt

kubectl config set-context $CLUSTER_NAME --cluster=$CLUSTER_NAME
kubectl config set-credentials boundary-user --token=$REMOTE_USER_TOKEN
kubectl config set-context $CLUSTER_NAME --user=boundary-user
kubectl config use-context $CLUSTER_NAME