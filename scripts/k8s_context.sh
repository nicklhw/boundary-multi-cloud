#!/usr/bin/env bash

# This script sets the Kubernetes context after a Boundary session is created.
# Before you run this script:
# 1. Establish session thru Boundary desktop.
# 2. Copy Boundary proxy port value as PORT environment variable.
# 3. Copy service_account_token value as REMOTE_USER_TOKEN environment variable.
# 4. Copy ca_crt value as CA_RAW variable.

export CLUSTER_NAME=my-aks-cluster
export PORT=59267
export REMOTE_USER_TOKEN=eyJhbGciOiJSUzI1NiIsImtpZCI6IkU2Y3J1X3B2aWhQOUU5c2FPdmVWZjhOc1d2cW1INVIzcHdDYUllaDZ5M2MifQ.eyJhdWQiOlsiaHR0cHM6Ly9ib3VuZGFyeS1kZW1vLXI1aTRjZHphLmhjcC5lYXN0dXMyLmF6bWs4cy5pbyIsIlwiYm91bmRhcnktZGVtby1yNWk0Y2R6YS5oY3AuZWFzdHVzMi5hem1rOHMuaW9cIiJdLCJleHAiOjE3MDc0MjgwODIsImlhdCI6MTcwNzQwNjQ4MiwiaXNzIjoiaHR0cHM6Ly9ib3VuZGFyeS1kZW1vLXI1aTRjZHphLmhjcC5lYXN0dXMyLmF6bWs4cy5pbyIsImt1YmVybmV0ZXMuaW8iOnsibmFtZXNwYWNlIjoiZGVmYXVsdCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJ2LXRva2VuLXRvLWF1dG8tbWFuLTE3MDc0MDY0ODItcXptdW50OWt3dmc5ZHJzbDVmd3dybnZiIiwidWlkIjoiNzllYzliMWItMDYxZS00Y2ZlLTg3NDItOWI2Y2I1Yzg2OTAxIn19LCJuYmYiOjE3MDc0MDY0ODIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnYtdG9rZW4tdG8tYXV0by1tYW4tMTcwNzQwNjQ4Mi1xem11bnQ5a3d2ZzlkcnNsNWZ3d3JudmIifQ.ICK7b_X35DkdCGpX2lKMBOqKpCQZ7qbdpn4rpJZ2BCcYGiVK6cJKACCk2ovHS0tpHxU4KrL36vkK-XVyHXmCxqY8Sh8n8Nl_fS3pSgb_SsCW92jTvycCXUznPcOSrjkFoCWMpIvftnkFUFpOb48qXpSZESltLUcWiIpdpZlFMuD276w_qzHJDQKnPCC9tneNY2UZBCNlDJ0bgI8FOTqnjRmY5j4LJXITvMlQ23i4sfTchclbX7SaL3eP4ujeu2lMWazWmhI0KqH64a_2y3H16GTFkABlFZr5BmteV21MzULlZIgf3A_ljptI2Mm7M7fsBT34JjFEVgkWperLXiS2CR0955F98SV_aG3LYDQWOv4UL3PTWAdKmCtWPvW1AINBjTCLQRMBivNwuljkBcU0yRee8UESTsbsnCcG4GUemSDJPyGDAi38ZuZF2ZnILv7silUO9DaAtjjJcbH_sppVDC6z_vX7vTQc-w5VeWaeFZFeUJ9VMT0WX74MGM589Y0gyZsseib-5qka9wS6gWKalmW3M5C94bhq-w1D4nLubbA_A4BwwXvrhzLDCG0_WzwnR_b3Sii_FuXGJrbF6hCvQyMcD0HyUu-1QoDXBPWFwbXP6m7G7SygaTI0GfRaFz6SruahMHmCTZUO5njW8yz6zaItBk5nyxsXIHc4H4K_lF4
CA_RAW="-----BEGIN CERTIFICATE-----\nMIIE6TCCAtGgAwIBAgIRAOMjwkACJasTIPaAkQePu0owDQYJKoZIhvcNAQELBQAw\nDTELMAkGA1UEAxMCY2EwIBcNMjQwMjA2MjAyNjQ5WhgPMjA1NDAyMDYyMDM2NDla\nMA0xCzAJBgNVBAMTAmNhMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA\nq9uiXkANIi4JXx9/JL21pCuxpuGQswhg100HrOcDsmbJxaVHzvaKD1pneXqSrg8J\n/oFQ4Ne4X3+D2ItJuG5otltzM3zB3QdZcUFZL1UdAGbXL7wtFKa91LEo102xotCw\nM/wY5MDuQD7yK9hCJmqFo4Mv8xbErK41lCffiLPOdNww3NO0awaKjwZkO+VBhTpL\nLKPYgXsu8523dvmg3DJ0l2OpdsjYSoxE0NldR9i30WVM25RUM9qywk0k+iiKACnf\niZQH/ttxziLo6SZtThmO0G2EUGGgmOX33coc4AwuKmkd3UHnL4CFv0Z5+Vtjh5u4\nu3Wtr9y6VCf6OrdLV9GVaaEmEjODs4jKkE8AvPSO7h17F0sZNGYMiTSQnlyUuomm\nd5zj4HTzYAKJqGSxcqA848cRC1jnCgkgGmnBnNlgptjrfsu8UENNevmd3dA6yvrn\nhth6GKMZWHBe7U1i+6yJjgkBTm7Bzl5g6sr1n78+nHv6fY/gyuEJpROs114Z7ngN\njEaKeOwm6TC5OqEPxFDRTDMeRkkx5J2N4X9Fk+W647bcywZBmLClGqZpVnaLdK+t\n2lGZnv/pnbXHQi5PLDvR5PJVayV6qUTd1TsBuAbvoKP3ax3N1pDXKgATL331bqtx\nfUjWcaDO1jtkhf2NagxGUJniIU/xr+7vBYmKdRzMRuECAwEAAaNCMEAwDgYDVR0P\nAQH/BAQDAgKkMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFKM+5CSQO8dAzuqq\n/WjPWjaA2NA8MA0GCSqGSIb3DQEBCwUAA4ICAQAh9B8IUePaVvaaYs+za6kC9Hyv\n+GcZ4uxa/j+R5EqR6JSPayFceSLXjArGvnTlLbgL0/QAsHlcve9I2RtbJuuHsPUo\ncQW9WTdblYu9blJSfuvOQ4dKbbwYM7kKLgiXocE6orYKCtxgOGm5fKHcmZRMU9/R\nmkzDu/kpvSTENp1vTTPA6AM1Z2mJ9VwQsdQO1VH3DaPh9fXbaQfgqj2YkfVxiUwv\nj5LO8STkjKCtRlr7pDTZ4ispST7+n6i4bvtYt2BCrm6wno4/9/s5Q1pnKLwyO/Op\nn1dwbeAtAi4cHGwJNgZWALtiD6MQTw8bg1lL9ipmpMVdDieZMqTHMHpHwynK+FMW\nEm71AB7FpnoRrXryiKm9MM4X7kmR8JRXlir6+iuhnHPlf93xDNlZcUtzA9vCfCX4\n6gQja3rIqQPcEHDr2wQmvRTnVQ3ffdWjZbaatdquYfvDNFsbrZimKPGs1P99yNzU\nGOtn5plpwMzHd0xQzYShHu8tlmBUlRtYXv0Xd9RejjOQvZ0bwiIB/GIBcRIdoiQD\naFhvKaIP7vxa+7bQQ3fRhpErLZYjtlsM6lWQBaLOea59ZiYuzSWIpCB/QvchMyR1\n3Rc6vV8xP9BUNMpknxfFTFGUztJ6hyZMIIIA8DWzSmj8oqwj/rCRHHOOlpMxTy4V\nj9bD0GDVn+qbedVenA==\n-----END CERTIFICATE-----\n"

tput setaf 12 && echo "### Setting Kubernetes context ###" && tput sgr0

echo "--> Cluster name is: ${CLUSTER_NAME}"
echo "--> Port number is: ${PORT}"
echo "Configuring Kubernetes contexts..."

echo $CA_RAW | sed 's/\\n/\n/g' | sed 's/"//' > ./scripts/ca.crt

kubectl config set-cluster $CLUSTER_NAME --server=https://127.0.0.1:$PORT --tls-server-name kubernetes --certificate-authority=./scripts/ca.crt

kubectl config set-context $CLUSTER_NAME --cluster=$CLUSTER_NAME
kubectl config set-credentials boundary-user --token=$REMOTE_USER_TOKEN
kubectl config set-context $CLUSTER_NAME --user=boundary-user
kubectl config use-context $CLUSTER_NAME